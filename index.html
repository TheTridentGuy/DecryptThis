<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decrypt This</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <style>
        :root {
            --main-color: #0f0;
            --main-bg: #000;
        }
        * {
            padding: 0;
            margin: 0;
        }
        #terminal, body {
            background-color: var(--main-bg);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="terminal">
    </div>
    <script>
        var input = "";
        var files = {
            "test.txt": "U2FsdGVkX18D9JzZUR4/TdPfWLA7vojqaCnRYjdZQXMw1+LLPetn8/4RVCTlajXP",
        };
        var term = new Terminal({
            cursorBlink: true,
            theme: {
            background: '#000',
            }
        });
        var webLinksAddon = new WebLinksAddon.WebLinksAddon();
        var fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.loadAddon(webLinksAddon);
        term.open(document.getElementById("terminal"));
        fitAddon.fit();
        document.addEventListener("resize", () => {
            fitAddon.fit();
        });
        var return_callback = run_command;
        term.onKey((event) => {
            const key = event.domEvent.key;
            if (key === 'ArrowUp' || key === 'ArrowDown' || key === 'ArrowLeft' || key === 'ArrowRight') {
                throw new Error("no arrow keys allowed"); // apparently preventDefault doesn't work
                event.domEvent.preventDefault();  // Prevent the default behavior of arrow keys
            }
        });
        term.onData((data) => {
            if (data === "\r") {
                return_callback();
            } else if (data === "\x7f") {
                if (input.length > 0) {
                    input = input.slice(0, -1);
                    term.write("\b \b");
                }
            } else if (data === "\n") {
                return_callback();
            } else {
                term.write("\x1b[37m"+data);
                input += data;
            }
        });
        intro();
        term.focus();
        async function run_command() {
            term.writeln("");
            if (input === "") {
                prompt();
            } else if (input === "help") {
                term.writeln("built-in commands:\n\rhelp - display this help text\n\rls - list available files\n\rdecrypt [filename] - decrypt a file, i.e. 'decrypt file.txt'\n\rclear - clear the screen\n\ruwu - ???\n\rabout - learn about crypt\n\rtry running 'decrypt test.txt'");
                prompt();
            } else if (input === "ls") {
                ls();
                prompt();
            } else if (input === "about") {
                term.writeln("Made with :3 by TheTridentGuy (http://thetridentguy.xyz)\n\rOpen source at: https://github.com/TheTridentGuy/DecryptThis\n\rBuilt with xterm.js and CryptoJS");
                prompt();
            } else if (input.startsWith("decrypt")) {
                decrypt(input.split(" ")[1]);
            } else if (input === "clear") {
                prompt();
                term.clear();
            } else if (input === "uwu") {
                term.writeln(":3");
                prompt();
            } else {
                term.writeln(input + ": command not found");
                prompt();
            }
        }

        function decrypt(file) {
            if (files[file]) {
                term.writeln("preparing to decrypt " + file);
                term.write("enter decryption key: ");
                input = "";
                return_callback = function() {
                    term.writeln("");
                    var decrypted = CryptoJS.AES.decrypt(files[file], input).toString(CryptoJS.enc.Utf8);
                if (decrypted.startsWith("PLAINTEXT")) {
                        term.writeln("decryption successful");
                        downloadDataURL(file, decrypted.substring(9));
                    } else {
                        term.writeln("decryption failed");
                    }
                    return_callback = run_command;
                    prompt();
                };
            } else {
                term.writeln("no such file: " + file);
                prompt();
            }
        }

        function ls() {
            for (var key in files) {
                term.writeln(key);
            }
        }

        function intro() {
            term.writeln("\x1b[37mCrypt v1.0");
            term.writeln("Type 'help' to get a list of commands");
            prompt();
        }

        function prompt() {
            term.write("\x1b[1;32mcrypt@crypt\x1b[37m:\x1b[34m~ $ \x1b[0m");
            input = "";
        }

        function downloadDataURL(name, data_url) {
            const link = document.createElement('a');
            link.href = data_url;
            link.download = name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function encrypt_data_url(name, data_url, password) {
            var encrypted = CryptoJS.AES.encrypt("PLAINTEXT" + data_url, password).toString();
            console.log(encrypted);
        }
    </script>
</body>
</html>